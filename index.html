<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Cassa Supermercato</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark gray text */
        }
        .dark body {
            background-color: #111827; /* Dark background */
            color: #f9fafb; /* Light text */
        }
        /* General styling for rounded corners */
        .rounded-lg {
            border-radius: 0.5rem;
        }
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .border {
            border-width: 1px;
        }
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        .dark .border-gray-700 {
            border-color: #374151;
        }
        .bg-white {
            background-color: #ffffff;
        }
        .dark .bg-gray-800 {
            background-color: #1f2937;
        }
        .bg-gray-50 {
            background-color: #f9fafb;
        }
        .dark .bg-gray-700 {
            background-color: #374151;
        }
        .bg-blue-50 {
            background-color: #eff6ff;
        }
        .dark .bg-blue-900 {
            background-color: #1e3a8a;
        }
        .text-gray-900 {
            color: #1f2937;
        }
        .dark .text-gray-100 {
            color: #f9fafb;
        }
        .text-gray-700 {
            color: #374151;
        }
        .dark .text-gray-300 {
            color: #d1d5db;
        }
        .text-blue-500 {
            color: #3b82f6;
        }
        .dark .text-blue-400 {
            color: #60a5fa;
        }
        .text-red-500 {
            color: #ef4444;
        }
        .dark .text-red-400 {
            color: #f87171;
        }
        .text-green-600 {
            color: #16a34a;
        }
        .dark .text-green-400 {
            color: #4ade80;
        }
        .text-purple-600 {
            color: #9333ea;
        }
        .dark .text-purple-300 {
            color: #c084fc;
        }
        .text-indigo-600 {
            color: #4f46e5;
        }
        .dark .text-indigo-400 {
            color: #818cf8;
        }
        .focus\:ring-blue-500:focus {
            --tw-ring-color: #3b82f6;
        }
        .focus\:border-blue-500:focus {
            border-color: #3b82f6;
        }
        .focus\:ring-green-500:focus {
            --tw-ring-color: #22c55e;
        }
        .focus\:ring-indigo-500:focus {
            --tw-ring-color: #6366f1;
        }
        .focus\:ring-purple-500:focus {
            --tw-ring-color: #a855f7;
        }
        /* Custom button styles */
        button {
            transition: all 0.3s ease-in-out;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        button.bg-blue-600:hover { background-color: #2563eb; }
        button.bg-green-600:hover { background-color: #15803d; }
        button.bg-indigo-600:hover { background-color: #4338ca; }
        button.bg-purple-600:hover { background-color: #7e22ce; }
        button.bg-gray-200:hover { background-color: #d1d5db; }
        .dark button.bg-gray-700:hover { background-color: #4b5563; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Notification Container -->
    <div id="app-notification" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg text-white text-center shadow-lg hidden transition-all duration-300 ease-in-out transform">
        <!-- Notification message will go here -->
    </div>

    <!-- Step 0: Role Selection -->
    <div id="role-selection-step" class="w-full max-w-md bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Seleziona il tuo ruolo</h2>
        <div class="space-y-4">
            <button id="select-tablet-role" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Sono il Tablet
            </button>
            <button id="select-phone-role" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                Sono il Telefono
            </button>
        </div>
    </div>

    <!-- Step 1: Device Pairing -->
    <div id="pairing-step" class="w-full max-w-xl bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col items-center hidden">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Accoppiamento Dispositivi</h2>

        <div id="tablet-pairing-ui" class="flex flex-col items-center w-full hidden">
            <p class="text-center text-gray-700 dark:text-gray-300 mb-4">
                Tablet in attesa di accoppiamento con il Telefono...
            </p>
            <div id="available-phones-list" class="w-full mt-4">
                <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Telefoni Disponibili:</h3>
                <ul class="space-y-2" id="phones-list-container">
                    <li class="text-gray-500 dark:text-gray-400">Nessun telefono disponibile.</li>
                </ul>
            </div>
        </div>

        <div id="phone-pairing-ui" class="flex flex-col items-center w-full hidden">
            <p class="text-center text-gray-700 dark:text-gray-300 mb-4">
                Telefono in attesa di essere selezionato dal Tablet...
            </p>
        </div>
        <p id="pairing-status" class="mt-4 text-center text-green-600 dark:text-green-400 font-bold hidden"></p>
    </div>

    <!-- Step 2: Tablet Main App -->
    <div id="tablet-app" class="w-full max-w-4xl bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 hidden relative">
        <button id="home-button-tablet" class="absolute top-4 left-4 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
            Home
        </button>
        <h2 class="text-3xl font-bold mb-8 text-center text-gray-900 dark:text-gray-100">Cassa Supermercato (Tablet)</h2>
        <p id="tablet-pairing-status" class="text-center text-green-600 dark:text-green-400 mb-6 font-semibold hidden"></p>

        <!-- Product Creation Form -->
        <div class="mb-8 p-6 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner">
            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Crea Nuovo Prodotto</h3>
            <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="productName">Nome</label>
                    <input type="text" id="productName" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="productCost">Costo (€)</label>
                    <input type="number" id="productCost" step="0.01" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="productContents">Contenuto / Descrizione</label>
                    <textarea id="productContents" rows="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100" required></textarea>
                </div>
                <div class="md:col-span-2">
                    <button type="submit" id="add-product-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                        Aggiungi Prodotto
                    </button>
                </div>
            </form>
        </div>

        <!-- Scanned Product Display -->
        <div class="mb-8 p-6 bg-blue-50 dark:bg-blue-900 rounded-lg shadow-md border border-blue-200 dark:border-blue-700">
            <h3 class="text-xl font-semibold mb-4 text-blue-800 dark:text-blue-200">Prodotto Scansionato</h3>
            <div id="scanned-product-details" class="space-y-2 text-blue-700 dark:text-blue-300">
                <p class="text-center">In attesa di scansione dal telefono...</p>
            </div>
        </div>

        <!-- Product List -->
        <div>
            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Prodotti Registrati</h3>
            <div id="product-list-container" class="overflow-x-auto">
                <p class="text-center text-gray-700 dark:text-gray-300">Nessun prodotto registrato.</p>
            </div>
        </div>
    </div>

    <!-- Step 2: Phone Main App -->
    <div id="phone-app" class="w-full max-w-md bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col items-center hidden relative">
        <button id="home-button-phone" class="absolute top-4 left-4 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
            Home
        </button>
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Scanner Telefono</h2>
        <p id="phone-pairing-status" class="text-center text-green-600 dark:text-green-400 mb-6 font-semibold hidden"></p>

        <div class="w-full">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="barcodeScan">Scansiona Codice a Barre</label>
            <form id="barcode-scan-form" class="space-y-4">
                <input type="text" id="barcodeScan" placeholder="Inserisci il codice a barre" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                <button type="submit" id="barcode-scan-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    Invia al Tablet
                </button>
            </form>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        // --- Global State ---
        let deviceInstanceId = null; // Unique ID for this specific browser tab/window instance
        let deviceRole = 'unknown'; // 'tablet' or 'phone'
        let currentStep = 0; // 0 for role selection, 1 for pairing, 2 for main app
        let currentPairing = null; // The specific pairing object this device is part of
        let products = [];
        let notificationTimeout;

        // --- Constants for Local Storage and Messaging ---
        const LS_KEY_DEVICE_INFO = 'supermarketApp_device_info'; // Stores { deviceInstanceId, deviceRole }
        const LS_KEY_ACTIVE_DEVICES = 'supermarketApp_active_devices'; // Stores map of all active devices { [id]: { role, timestamp } }
        const LS_KEY_CURRENT_PAIRING_SESSION = 'supermarketApp_current_pairing_session'; // Stores the single active pairing session { id, tabletDeviceId, phoneDeviceId, isPaired, scannedProductId }
        const PAIRING_MESSAGE_TYPE = 'supermarketApp_pairing_update';
        const STALE_DEVICE_TIMEOUT_MS = 15000; // Devices older than 15 seconds are considered stale

        // --- Utility Functions ---

        // Simple ID generator
        const generateUniqueId = () => crypto.randomUUID();

        // --- UI Management Functions ---

        // Notification function
        const showNotification = (message, type = 'info') => { // type can be 'success', 'error', 'info'
            const notificationElement = document.getElementById('app-notification');
            if (notificationElement) {
                notificationElement.textContent = message;
                notificationElement.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
                notificationElement.classList.add('flex', 'items-center', 'justify-center'); // Make it a flex container to center text

                clearTimeout(notificationTimeout); // Clear any existing timeout

                if (type === 'success') {
                    notificationElement.classList.add('bg-green-500');
                } else if (type === 'error') {
                    notificationElement.classList.add('bg-red-500');
                } else {
                    notificationElement.classList.add('bg-blue-500'); // Default info color
                }

                // Hide after 3 seconds
                notificationTimeout = setTimeout(() => {
                    notificationElement.classList.add('hidden');
                }, 3000);
            }
        };

        const showStep = (stepNumber) => {
            document.getElementById('role-selection-step').classList.add('hidden');
            document.getElementById('pairing-step').classList.add('hidden');
            document.getElementById('tablet-app').classList.add('hidden');
            document.getElementById('phone-app').classList.add('hidden');

            currentStep = stepNumber;

            switch (stepNumber) {
                case 0: // Role Selection
                    document.getElementById('role-selection-step').classList.remove('hidden');
                    break;
                case 1: // Pairing Step
                    document.getElementById('pairing-step').classList.remove('hidden');
                    if (deviceRole === 'tablet') {
                        document.getElementById('tablet-pairing-ui').classList.remove('hidden');
                        document.getElementById('phone-pairing-ui').classList.add('hidden');
                    } else { // deviceRole === 'phone'
                        document.getElementById('tablet-pairing-ui').classList.add('hidden');
                        document.getElementById('phone-pairing-ui').classList.remove('hidden');
                    }
                    // Trigger pairing logic, which also updates active devices list
                    handlePairingDiscovery();
                    break;
                case 2: // Main App (Tablet or Phone)
                    if (deviceRole === 'tablet') {
                        document.getElementById('tablet-app').classList.remove('hidden');
                        document.getElementById('tablet-pairing-status').textContent = `Accoppiato. ID Sessione: ${currentPairing ? currentPairing.id : 'N/A'}`;
                        document.getElementById('tablet-pairing-status').classList.remove('hidden');
                    } else { // deviceRole === 'phone'
                        document.getElementById('phone-app').classList.remove('hidden');
                        document.getElementById('phone-pairing-status').textContent = `Accoppiato. ID Sessione: ${currentPairing ? currentPairing.id : 'N/A'}`;
                        document.getElementById('phone-pairing-status').classList.remove('hidden');
                    }
                    break;
            }
        };

        const setButtonLoading = (buttonId, isLoading, originalText) => {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = isLoading;
                button.textContent = isLoading ? `${originalText}...` : originalText;
            }
        };

        // --- Data Management (Local Storage & Cross-tab Communication) ---

        const saveStateToLocalStorage = () => {
            try {
                // Save device info (role and instance ID)
                localStorage.setItem(LS_KEY_DEVICE_INFO, JSON.stringify({ deviceInstanceId, deviceRole }));
                // Save current pairing session
                localStorage.setItem(LS_KEY_CURRENT_PAIRING_SESSION, JSON.stringify(currentPairing));
                // Save products
                localStorage.setItem('supermarketApp_products', JSON.stringify(products));

                console.log("State saved to Local Storage.");
            } catch (e) {
                console.error("Error saving to Local Storage:", e);
                showNotification("Errore nel salvataggio dei dati locali.", 'error');
            }
        };

        const loadStateFromLocalStorage = () => {
            try {
                // Load device info
                const deviceInfo = JSON.parse(localStorage.getItem(LS_KEY_DEVICE_INFO));
                if (deviceInfo) {
                    deviceInstanceId = deviceInfo.deviceInstanceId;
                    deviceRole = deviceInfo.deviceRole;
                } else {
                    deviceInstanceId = generateUniqueId(); // Generate new if not found
                    deviceRole = 'unknown';
                }

                // Load current pairing session
                currentPairing = JSON.parse(localStorage.getItem(LS_KEY_CURRENT_PAIRING_SESSION));

                // Load products
                products = JSON.parse(localStorage.getItem('supermarketApp_products')) || [];

                console.log("State loaded from Local Storage:", { deviceInstanceId, deviceRole, currentPairing, products });
                return true;
            } catch (e) {
                console.error("Error loading from Local Storage:", e);
                showNotification("Errore nel caricamento dei dati locali.", 'error');
            }
            return false;
        };

        const resetAppStateAndGoToRoleSelection = () => {
            deviceInstanceId = generateUniqueId(); // Generate a new ID for the new session
            deviceRole = 'unknown';
            currentPairing = null;
            products = [];
            localStorage.removeItem(LS_KEY_DEVICE_INFO);
            localStorage.removeItem(LS_KEY_ACTIVE_DEVICES);
            localStorage.removeItem(LS_KEY_CURRENT_PAIRING_SESSION);
            localStorage.removeItem('supermarketApp_products');
            showStep(0); // Go back to role selection
            showNotification('Stato resettato. Seleziona il tuo ruolo.', 'info');
        };

        // --- Device Discovery and Pairing Logic ---

        const updateActiveDevices = () => {
            let activeDevices = JSON.parse(localStorage.getItem(LS_KEY_ACTIVE_DEVICES)) || {};
            const now = Date.now();

            // Remove stale devices
            for (const id in activeDevices) {
                if (now - activeDevices[id].timestamp > STALE_DEVICE_TIMEOUT_MS) {
                    delete activeDevices[id];
                }
            }

            // Add/update current device's presence, ensuring deviceInstanceId is part of the stored object
            activeDevices[deviceInstanceId] = {
                id: deviceInstanceId, // Explicitly add id to the object
                role: deviceRole,
                timestamp: now
            };

            localStorage.setItem(LS_KEY_ACTIVE_DEVICES, JSON.stringify(activeDevices));
            console.log("Active devices updated:", activeDevices);

            // Notify other tabs
            window.postMessage({
                type: PAIRING_MESSAGE_TYPE,
                action: 'active_devices_updated'
            }, window.location.origin);
        };

        const handlePairingDiscovery = () => {
            if (deviceRole === 'unknown') return; // Cannot pair if role is not set

            updateActiveDevices(); // Register self and clean up stale devices

            if (deviceRole === 'tablet') {
                renderAvailablePhones();
                // If already paired, transition to main app
                if (currentPairing && currentPairing.isPaired && currentPairing.tabletDeviceId === deviceInstanceId) {
                    showStep(2);
                    showNotification('Tablet già accoppiato.', 'success');
                } else {
                    showNotification('Tablet in attesa di selezione telefono.', 'info');
                }
            } else if (deviceRole === 'phone') {
                // Phone just waits for tablet to initiate pairing
                // It will react to 'pairing_initiated' message or on next loadStateFromLocalStorage
                if (currentPairing && currentPairing.isPaired && currentPairing.phoneDeviceId === deviceInstanceId) {
                    showStep(2);
                    showNotification('Telefono già accoppiato.', 'success');
                } else {
                    showNotification('Telefono in attesa di essere accoppiato dal tablet.', 'info');
                }
            }
        };

        const renderAvailablePhones = () => {
            const phonesListContainer = document.getElementById('phones-list-container');
            if (!phonesListContainer) return;

            const activeDevices = JSON.parse(localStorage.getItem(LS_KEY_ACTIVE_DEVICES)) || {};
            let availablePhones = Object.values(activeDevices).filter(device =>
                device.role === 'phone' && device.id !== deviceInstanceId && // Use device.id now
                (!currentPairing || (currentPairing.phoneDeviceId !== device.id && currentPairing.tabletDeviceId !== deviceInstanceId)) // Use device.id
            );

            phonesListContainer.innerHTML = ''; // Clear previous list

            if (availablePhones.length === 0) {
                phonesListContainer.innerHTML = `<li class="text-gray-500 dark:text-gray-400">Nessun telefono disponibile.</li>`;
            } else {
                availablePhones.forEach(phone => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm';
                    listItem.innerHTML = `
                        <span class="text-gray-800 dark:text-gray-200">Telefono (ID: ${phone.id.substring(0, 8)}...)</span>
                        <button class="pair-button bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm" data-phone-id="${phone.id}">
                            Accoppia
                        </button>
                    `;
                    phonesListContainer.appendChild(listItem);
                });

                // Add event listeners to new pair buttons
                document.querySelectorAll('.pair-button').forEach(button => {
                    button.onclick = (event) => {
                        const phoneIdToPair = event.target.dataset.phoneId;
                        initiatePairing(phoneIdToPair);
                    };
                });
            }
        };

        const initiatePairing = (phoneIdToPair) => {
            if (deviceRole !== 'tablet') {
                showNotification('Solo il tablet può avviare l\'accoppiamento.', 'error');
                return;
            }

            // Create/update the pairing session
            currentPairing = {
                id: generateUniqueId(),
                tabletDeviceId: deviceInstanceId,
                phoneDeviceId: phoneIdToPair,
                isPaired: true,
                scannedProductId: null,
                lastScannedAt: null,
                createdAt: new Date()
            };
            saveStateToLocalStorage();
            showNotification(`Accoppiamento avviato con il telefono ${phoneIdToPair.substring(0, 8)}...`, 'success');
            console.log("Pairing initiated:", currentPairing);

            // Notify all tabs about the new pairing
            window.postMessage({
                type: PAIRING_MESSAGE_TYPE,
                action: 'pairing_initiated',
                pairingId: currentPairing.id
            }, window.location.origin);

            showStep(2); // Move to main app
        };

        // --- Event Listeners ---

        // Role Selection Buttons
        document.getElementById('select-tablet-role').addEventListener('click', () => {
            deviceRole = 'tablet';
            saveStateToLocalStorage();
            showStep(1); // Go to pairing step
        });

        document.getElementById('select-phone-role').addEventListener('click', () => {
            deviceRole = 'phone';
            saveStateToLocalStorage();
            showStep(1); // Go to pairing step
        });

        // Add Home button listeners
        document.getElementById('home-button-tablet').addEventListener('click', resetAppStateAndGoToRoleSelection);
        document.getElementById('home-button-phone').addEventListener('click', resetAppStateAndGoToRoleSelection);

        // Add Product Form (Tablet)
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showNotification('', 'info');
            setButtonLoading('add-product-button', true, 'Aggiungi Prodotto');

            const productName = document.getElementById('productName').value;
            const productCost = document.getElementById('productCost').value;
            const productContents = document.getElementById('productContents').value;

            if (!productName || !productCost || !productContents) {
                showNotification('Tutti i campi del prodotto sono obbligatori.', 'error');
                setButtonLoading('add-product-button', false, 'Aggiungi Prodotto');
                return;
            }

            const newBarcode = generateUniqueId().substring(0, 12).toUpperCase();
            const newProduct = {
                id: generateUniqueId(),
                name: productName,
                cost: parseFloat(productCost),
                contents: productContents,
                barcode: newBarcode,
                createdAt: new Date()
            };
            products.push(newProduct); // Add to local products array
            saveStateToLocalStorage(); // Save state after adding product
            renderProductList();
            showNotification('Prodotto aggiunto con successo!', 'success');
            document.getElementById('productName').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productContents').value = '';
            setButtonLoading('add-product-button', false, 'Aggiungi Prodotto');
        });

        const renderProductList = () => {
            const container = document.getElementById('product-list-container');
            if (!container) return;

            if (products.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-700 dark:text-gray-300">Nessun prodotto registrato.</p>`;
            } else {
                let tableHtml = `
                    <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Nome</th>
                                <th class="py-3 px-6 text-left">Costo</th>
                                <th class="py-3 px-6 text-left">Contenuto</th>
                                <th class="py-3 px-6 text-left">Codice a Barre</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 dark:text-gray-300 text-sm font-light">
                `;
                products.forEach(product => {
                    tableHtml += `
                        <tr class="border-b border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${product.name}</td>
                            <td class="py-3 px-6 text-left">€${product.cost.toFixed(2)}</td>
                            <td class="py-3 px-6 text-left">${product.contents}</td>
                            <td class="py-3 px-6 text-left font-mono text-purple-600 dark:text-purple-300">${product.barcode}</td>
                        </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                container.innerHTML = tableHtml;
            }
        };

        // Barcode Scan Form (Phone)
        document.getElementById('barcode-scan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showNotification('', 'info');
            setButtonLoading('barcode-scan-button', true, 'Invia al Tablet');

            const scanInput = document.getElementById('barcodeScan').value;

            if (!scanInput) {
                showNotification('Inserisci un codice a barre da scansionare.', 'error');
                setButtonLoading('barcode-scan-button', false, 'Invia al Tablet');
                return;
            }

            // Always re-read the latest state from Local Storage to ensure synchronization
            loadStateFromLocalStorage();

            // Check if pairingData exists and is for the correct pair and roles
            if (!currentPairing || !currentPairing.id || !currentPairing.isPaired ||
                currentPairing.tabletDeviceId === null || currentPairing.phoneDeviceId !== deviceInstanceId) {
                showNotification('Errore: Il telefono non è accoppiato con un tablet valido.', 'error');
                setButtonLoading('barcode-scan-button', false, 'Invia al Tablet');
                return;
            }

            // Update the currentPairing with the scanned product ID
            currentPairing.scannedProductId = scanInput;
            currentPairing.lastScannedAt = new Date();
            saveStateToLocalStorage(); // Save state after updating scanned product

            showNotification(`Codice "${scanInput}" inviato al tablet.`, 'success');
            document.getElementById('barcodeScan').value = '';
            setButtonLoading('barcode-scan-button', false, 'Invia al Tablet');

            // Broadcast update to other tabs (especially the tablet)
            window.postMessage({
                type: PAIRING_MESSAGE_TYPE,
                action: 'product_scanned',
                pairingId: currentPairing.id,
                scannedProductId: scanInput
            }, window.location.origin);
        });


        // --- Initial Setup on Window Load ---
        window.onload = () => {
            // Load state from local storage. This will populate deviceInstanceId, deviceRole, currentPairing, products.
            loadStateFromLocalStorage();

            // If deviceInstanceId is not set (first time visit or cleared local storage)
            if (!deviceInstanceId) {
                deviceInstanceId = generateUniqueId(); // Assign a fresh ID for this instance
                saveStateToLocalStorage(); // Save this new ID immediately
                console.log("New session instance ID:", deviceInstanceId);
            } else {
                console.log("Loaded session instance ID:", deviceInstanceId);
            }

            // Determine initial step based on loaded state
            if (deviceRole === 'unknown') {
                showStep(0); // Show role selection if not chosen
            } else {
                // If role is known, proceed to pairing or main app based on pairing status
                if (currentPairing && currentPairing.isPaired &&
                    ((deviceRole === 'tablet' && currentPairing.tabletDeviceId === deviceInstanceId) ||
                     (deviceRole === 'phone' && currentPairing.phoneDeviceId === deviceInstanceId))) {
                    showStep(2); // Already paired, go to main app
                } else {
                    showStep(1); // Role chosen but not paired, go to pairing step
                }
            }

            // Set up a periodic check for active devices (for discovery)
            setInterval(updateActiveDevices, 5000); // Every 5 seconds

            // Add listener for messages from other tabs (for pairing updates)
            window.addEventListener('message', (event) => {
                // Ensure the message is from the same origin and of the correct type
                if (event.origin === window.location.origin && event.data && event.data.type === PAIRING_MESSAGE_TYPE) {
                    console.log("Received message from another tab:", event.data);
                    // Re-load the state from local storage to synchronize with the latest changes
                    loadStateFromLocalStorage();

                    // Handle different message actions
                    if (event.data.action === 'active_devices_updated') {
                        if (deviceRole === 'tablet' && currentStep === 1) {
                            renderAvailablePhones(); // Update list of phones
                        }
                        // Phone will re-evaluate its pairing status on next handlePairingDiscovery call
                    } else if (event.data.action === 'pairing_initiated' || event.data.action === 'product_scanned') {
                        // If a pairing was initiated or a product scanned, re-evaluate state
                        if (currentPairing && currentPairing.isPaired &&
                            ((deviceRole === 'tablet' && currentPairing.tabletDeviceId === deviceInstanceId) ||
                             (deviceRole === 'phone' && currentPairing.phoneDeviceId === deviceInstanceId))) {
                            showStep(2); // Paired, go to main app
                            if (event.data.action === 'pairing_initiated') {
                                showNotification('Dispositivi accoppiati con successo!', 'success');
                            }
                        } else if (currentStep === 1) {
                            // If still in pairing step, and not yet paired, re-trigger pairing logic
                            handlePairingDiscovery();
                        }
                    }
                }
            });
        };

    </script>
</body>
</html>
